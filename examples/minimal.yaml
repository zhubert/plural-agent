# Minimal workflow — code, open PR, wait for approval + CI, merge.
#
# Use this for small teams or bots where you want the simplest possible
# pipeline. Uses pr.mergeable to fire a single event when both review
# approval and CI pass, replacing the separate await_review + await_ci
# states from the default workflow.
#
# Highlights:
#   - pr.mergeable: combined review + CI wait in a single state
#   - squash merge for clean commit history
#   - settings block: max_concurrent, branch_prefix, cleanup_merged

workflow: minimal
start: coding

source:
  provider: github
  filter:
    label: queued

settings:
  max_concurrent: 5          # Allow up to 5 sessions running at once
  branch_prefix: bot/        # All branches will start with "bot/"
  cleanup_merged: true       # Delete branches and worktrees after merge

states:
  coding:
    type: task
    action: ai.code
    params:
      max_turns: 30
      max_duration: 20m
    next: open_pr
    error: failed

  open_pr:
    type: task
    action: github.create_pr
    params:
      link_issue: true
    next: await_merge
    error: failed

  # pr.mergeable fires when BOTH review approval AND CI pass.
  # No need to manage them as separate wait states.
  await_merge:
    type: wait
    event: pr.mergeable
    params:
      require_review: true   # Must be approved by a reviewer
      require_ci: true       # CI must pass
    timeout: 72h             # Time out after 3 days of inactivity
    timeout_next: timed_out
    next: merge
    error: failed

  # Comment on the PR and fail if the wait times out.
  timed_out:
    type: task
    action: github.comment_pr
    params:
      body: "This PR has been waiting 72h with no activity. Closing — re-label the issue to retry."
    next: failed
    error: failed

  merge:
    type: task
    action: github.merge
    params:
      method: squash         # Squash all commits into one for a clean history
      cleanup: true
    next: done

  done:
    type: succeed

  failed:
    type: fail
