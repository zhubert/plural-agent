# Linear integration — polls Linear issues and processes them automatically.
#
# Use this for teams that track work in Linear instead of GitHub Issues.
# Set your Linear team ID in source.filter.team. The agent polls for
# issues assigned to that team and processes them through this workflow.
#
# Replace "YOUR_LINEAR_TEAM_ID" with your team ID from:
#   Linear → Settings → Teams → <Your Team> → Team ID
#
# Highlights:
#   - linear provider with team filter
#   - inline system_prompt to embed AI instructions directly in the config
#   - git.format to auto-format code before opening a PR
#   - squash merge for a clean, linear commit history
#   - Slack notification after merge via after hook

workflow: linear-sprint
start: coding

source:
  provider: linear
  filter:
    team: YOUR_LINEAR_TEAM_ID

settings:
  max_concurrent: 3
  branch_prefix: linear/
  cleanup_merged: true

states:
  coding:
    type: task
    action: ai.code
    params:
      max_turns: 50
      max_duration: 30m
      system_prompt: |
        You are an expert software engineer working on this team's codebase.
        Follow the existing code style and architecture patterns exactly.
        Write tests for all new functionality.
        Keep changes focused and minimal — only address what the issue asks for.
        Do not refactor unrelated code or add unrequested features.
    next: format
    error: failed

  # Auto-format code before opening the PR to ensure consistent style.
  # Replace "make fmt" with your project's formatter command, e.g.:
  #   "go fmt ./..." for Go
  #   "npx prettier --write ." for JavaScript/TypeScript
  #   "black ." for Python
  format:
    type: task
    action: git.format
    params:
      command: "make fmt"
    next: open_pr
    error: open_pr             # If formatting fails, open the PR anyway

  open_pr:
    type: task
    action: github.create_pr
    params:
      link_issue: true
    next: await_ci
    error: failed

  await_ci:
    type: wait
    event: ci.complete
    timeout: 2h
    params:
      on_failure: retry        # Keep polling; CI may still pass on a subsequent run
    next: await_review
    error: failed

  await_review:
    type: wait
    event: pr.reviewed
    timeout: 48h
    timeout_next: review_overdue
    params:
      auto_address: true
      max_feedback_rounds: 3
    next: merge
    error: failed

  # Comment on the PR and fail if review takes too long.
  review_overdue:
    type: task
    action: github.comment_pr
    params:
      body: "This PR has been awaiting review for 48h. Could a maintainer take a look?"
    next: failed
    error: failed

  merge:
    type: task
    action: github.merge
    params:
      method: squash
      cleanup: true
    after:
      # Post to Slack after merge. SLACK_WEBHOOK_URL must be set in the environment.
      - run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{\"text\": \"Merged: $PLURAL_ISSUE_TITLE\\n$PLURAL_PR_URL\"}"
    next: done

  done:
    type: succeed

  failed:
    type: fail
