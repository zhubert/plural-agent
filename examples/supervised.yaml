# Supervised workflow — for complex features spanning multiple files.
#
# Claude acts as a supervisor that can spawn child sessions for parallel
# work across different subsystems. A custom system prompt enforces
# architectural guidelines. Hooks install dependencies before coding and
# run lint checks after. Failed sessions are retried with exponential
# backoff before routing to a recovery state.
#
# Highlights:
#   - supervisor: true for multi-session task coordination
#   - system_prompt loaded from a file for per-repo AI guidelines
#   - before hooks (block on failure) and after hooks (fire-and-forget)
#   - retry with exponential backoff before catch-based error routing
#   - Slack webhook notification after merge via after hook

workflow: supervised-feature
start: coding

source:
  provider: github
  filter:
    label: feature-queued

settings:
  max_concurrent: 2          # Supervisor sessions are resource-heavy; limit concurrency
  branch_prefix: feature/
  cleanup_merged: true

states:
  coding:
    type: task
    action: ai.code
    params:
      max_turns: 100
      max_duration: 60m
      supervisor: true                                   # Enable multi-session coordination
      system_prompt: "file:.plural/prompts/feature.md"  # Architecture + style guidelines
    before:
      - run: "make deps"      # Install dependencies before Claude starts (blocks on failure)
      - run: "make generate"  # Run code generation (blocks on failure)
    after:
      - run: "make lint"      # Run lint after coding (logged on failure, does not block)
    retry:
      - max_attempts: 2
        interval: 60s
        backoff_rate: 2.0     # Wait 60s, then 120s between retries
        errors: ["*"]         # Retry on any failure
    catch:
      - errors: ["container_error"]
        next: notify_container_failure  # Container issues get a human-readable comment
      - errors: ["*"]
        next: failed                    # All other failures → fail
    next: open_pr
    error: failed

  open_pr:
    type: task
    action: github.create_pr
    params:
      link_issue: true
    next: await_ci
    error: failed

  await_ci:
    type: wait
    event: ci.complete
    timeout: 3h
    params:
      on_failure: retry       # Keep polling; CI may pass on re-run
    next: await_review
    error: failed

  await_review:
    type: wait
    event: pr.reviewed
    params:
      auto_address: true
      max_feedback_rounds: 5  # Allow more review rounds for complex features
      system_prompt: "file:.plural/prompts/review-feedback.md"
    next: merge
    error: failed

  merge:
    type: task
    action: github.merge
    params:
      method: rebase
      cleanup: true
    after:
      # Post to Slack after merge. SLACK_WEBHOOK_URL must be set in the environment.
      - run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{\"text\": \"Feature merged: <$PLURAL_PR_URL|$PLURAL_ISSUE_TITLE>\"}"
    next: done

  # Post a comment when a container error prevents coding, then fail.
  notify_container_failure:
    type: task
    action: github.comment_issue
    params:
      body: "The coding session failed due to a container error. Please check the infrastructure and re-queue the issue."
    next: failed
    error: failed

  done:
    type: succeed

  failed:
    type: fail
