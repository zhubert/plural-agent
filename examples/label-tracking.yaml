# Label-tracking workflow — use GitHub labels to show workflow progress.
#
# Issues move through labels as they advance: queued → in-progress →
# in-review, and the source issue is closed automatically after merge.
# A pass state at the top injects configuration flags that a downstream
# choice state reads to decide whether to auto-close the issue.
#
# Highlights:
#   - pass state to inject workflow configuration at startup
#   - choice state reads pass-state data to conditionally close the issue
#   - github.add_label / github.remove_label for real-time status tracking
#   - github.close_issue to close the source issue after merge

workflow: label-tracking
start: configure

source:
  provider: github
  filter:
    label: queued

states:
  # Inject static workflow configuration into step data.
  # Downstream states can read these values via choice rules.
  configure:
    type: pass
    data:
      close_issue_on_merge: true   # Set to false to keep the issue open after merge
    next: start_coding

  # Remove the "queued" label and add "in-progress" when work begins.
  start_coding:
    type: task
    action: github.remove_label
    params:
      label: queued
    next: label_in_progress
    error: label_in_progress       # Continue even if the label was already missing

  label_in_progress:
    type: task
    action: github.add_label
    params:
      label: in-progress
    next: coding
    error: coding                  # Continue even if labeling fails

  coding:
    type: task
    action: ai.code
    params:
      max_turns: 50
      max_duration: 30m
    next: label_in_review
    error: label_failed

  # Swap labels from "in-progress" to "in-review" before opening the PR.
  label_in_review:
    type: task
    action: github.remove_label
    params:
      label: in-progress
    next: add_in_review
    error: add_in_review

  add_in_review:
    type: task
    action: github.add_label
    params:
      label: in-review
    next: open_pr
    error: open_pr

  open_pr:
    type: task
    action: github.create_pr
    params:
      link_issue: true
    next: await_merge
    error: label_failed

  await_merge:
    type: wait
    event: pr.mergeable
    params:
      require_review: true
      require_ci: true
    timeout: 72h
    timeout_next: label_failed     # Route to label_failed after 3 days of inactivity
    next: merge
    error: label_failed

  merge:
    type: task
    action: github.merge
    params:
      method: rebase
      cleanup: true
    next: check_close

  # Read the close_issue_on_merge flag set by the configure pass state.
  check_close:
    type: choice
    choices:
      - variable: close_issue_on_merge
        equals: true
        next: close_issue
    default: done

  close_issue:
    type: task
    action: github.close_issue     # Close the source issue after a successful merge
    next: done
    error: done                    # Proceed to done even if the close fails

  done:
    type: succeed

  # Add a "bot-failed" label so failed issues are easy to find.
  label_failed:
    type: task
    action: github.add_label
    params:
      label: bot-failed
    next: failed
    error: failed

  failed:
    type: fail
